# 头脑风暴流程完整指南

## 概述

本文档详细描述了 YiQi 头脑风暴平台的完整流程，包括接口调用顺序、状态流转和测试示例。

## 阶段状态流转图

```
NOT_STARTED → IN_PROGRESS → WAITING_APPROVAL → APPROVED → COMPLETED
                    ↑              ↓
                    └── REJECTED ←──┘
                         ↓
                    [retry接口]
```

## 完整的头脑风暴流程接口调用顺序

### 1. 初始化阶段 (NOT_STARTED)

#### 1.1 创建会话

```http
POST /api/sessions
```

**请求体:**

```json
{
  "title": "产品创新头脑风暴",
  "description": "针对新产品功能的创新思考和讨论",
  "agentIds": [1, 2, 3]
}
```

**结果:** 创建会话并初始化三个阶段，所有阶段状态为 NOT_STARTED

#### 1.2 启动会话

```http
POST /api/sessions/{sessionId}/start
```

**请求体:**

```json
{
  "topic": "如何设计一个更好的移动应用用户界面"
}
```

**结果:**

- 会话状态变为 IN_PROGRESS
- 第一阶段（创意生成）状态变为 IN_PROGRESS

### 2. 第一阶段：创意生成 (IDEA_GENERATION)

#### 2.1 查看阶段状态

```http
GET /api/sessions/{sessionId}/status
```

**说明:** 查看当前阶段进度和代理响应情况

#### 2.2 执行创意生成阶段（由 AI 代理自动完成）


**接口地址**: `POST /api/sessions/{sessionId}/phases/IDEA_GENERATION/execute`

**接口描述**: 执行创意生成阶段的AI代理推理过程，调用AI生成创意想法并自动提交审核

**请求头**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
| 参数名    | 类型 | 必填 | 说明    |
| --------- | ---- | ---- | ------- |
| sessionId | Long | 是   | 会话 ID |

**请求参数**:

```json
{
  "topic": "如何设计一个更好的移动应用用户界面"
}
```

**参数说明**:
| 参数名 | 类型   | 必填 | 说明                            | 示例                                 |
| ------ | ------ | ---- | ------------------------------- | ------------------------------------ |
| topic  | String | 是   | 头脑风暴主题，不超过 500 个字符 | "如何设计一个更好的移动应用用户界面" |

**响应**: 无内容

**状态码**:

- `200`: 执行成功，AI推理完成并自动提交审核
- `400`: 请求参数无效或会话状态不允许执行
- `401`: 未授权
- `404`: 会话不存在
- `500`: AI推理执行失败

**说明**:
- 该接口会调用所有参与会话的AI代理执行创意生成任务
- 所有代理的响应内容会被收集并存储到phases表的summary字段中
- 执行完成后会自动调用submit-for-approval接口提交审核
- 阶段状态会从IN_PROGRESS变为WAITING_APPROVAL

#### 2.3 审核通过第一阶段

```http
POST /api/sessions/{sessionId}/phases/IDEA_GENERATION/approve
```

**结果:**

- 第一阶段状态变为 APPROVED → COMPLETED
- 当前阶段所有agent的成功content都将存储在phases表的summary字段当中，便于生成最终的总结报告
- 第二阶段（技术可行性分析）自动开始，状态变为 IN_PROGRESS

### 3. 第二阶段：技术可行性分析 (FEASIBILITY_ANALYSIS)

#### 3.1 查看当前阶段状态

```http
GET /api/sessions/{sessionId}/status
```

#### 3.2 执行创意生成阶段（由 AI 代理自动完成）


**接口地址**: `POST /api/sessions/{sessionId}/phases/FEASIBILITY_ANALYSIS/execute`

**结果:** 阶段状态变为 WAITING_APPROVAL

#### 3.3 审核通过第二阶段

```http
POST /api/sessions/{sessionId}/phases/FEASIBILITY_ANALYSIS/approve
```

**结果:**

- 第二阶段状态变为 APPROVED → COMPLETED
- 当前阶段所有agent的成功content都将存储在phases表的summary字段当中，便于生成最终的总结报告
- 第三阶段（缺点讨论）自动开始，状态变为 IN_PROGRESS

### 4. 第三阶段：缺点讨论 (DRAWBACK_DISCUSSION)

#### 4.1 查看当前阶段状态

```http
GET /api/sessions/{sessionId}/status
```

#### 4.2 执行创意生成阶段（由 AI 代理自动完成）


**接口地址**: `POST /api/sessions/{sessionId}/phases/DRAWBACK_DISCUSSION/execute`

**结果:** 阶段状态变为 WAITING_APPROVAL

#### 4.3 审核通过第三阶段

```http
POST /api/sessions/{sessionId}/phases/DRAWBACK_DISCUSSION/approve
```

**结果:**

- 第三阶段状态变为 APPROVED → COMPLETED
- 当前阶段所有agent的成功content都将存储在phases表的summary字段当中，便于生成最终的总结报告
- 整个会话状态变为 COMPLETED

### 5. 查看最终结果

#### 5.1 获取完整会话状态

```http
GET /api/sessions/{sessionId}/status
```

#### 5.2 获取所有阶段详情

```http
GET /api/sessions/{sessionId}/phases
```

#### 5.3 获取特定阶段详情

```http
GET /api/sessions/{sessionId}/phases/IDEA_GENERATION
GET /api/sessions/{sessionId}/phases/FEASIBILITY_ANALYSIS
GET /api/sessions/{sessionId}/phases/DRAWBACK_DISCUSSION
```

## 详细的状态流转过程

### 1. NOT_STARTED → IN_PROGRESS

- **触发方式:** 启动会话时自动触发
- **接口调用:** `POST /api/sessions/{sessionId}/start`
- **说明:** 当调用启动会话接口时，系统会自动将第一个阶段(IDEA_GENERATION)的状态从 NOT_STARTED 变更为 IN_PROGRESS

### 2. IN_PROGRESS → WAITING_APPROVAL

- **触发方式:** 调用 submit-for-approval 接口
- **接口调用:** `POST /api/sessions/{sessionId}/phases/{phaseType}/submit-for-approval`
- **请求体:** `{"summary": "阶段总结内容"}`

### 3. WAITING_APPROVAL → APPROVED

- **触发方式:** 用户审核通过
- **接口调用:** `POST /api/sessions/{sessionId}/phases/{phaseType}/approve`
- **实现思路:**
  - 系统会查询该阶段下所有状态为SUCCESS的agent响应记录
  - 将所有agent成功生成的content内容收集并存储在phases表的summary字段当中
  - 更新阶段状态为APPROVED
  - 系统自动触发下一个状态流转（APPROVED → COMPLETED）

### 4. APPROVED → COMPLETED

- **触发方式:** 系统自动触发
- **说明:** 当阶段被审核通过后，系统会自动将状态变更为 COMPLETED，并启动下一个阶段

## 完整的测试流程示例

假设测试会话 6 的完整流程：

### 步骤 1: 启动会话

```bash
curl -X POST "http://localhost:8080/api/sessions/6/start" \
  -H "Authorization: Bearer your-jwt-token" \
  -H "Content-Type: application/json" \
  -d '{
    "topic": "智能推荐系统设计"
  }'
```

### 步骤 2: 检查阶段状态

```bash
curl -X GET "http://localhost:8080/api/sessions/6/phases/IDEA_GENERATION" \
  -H "Authorization: Bearer your-jwt-token"
```

### 步骤 3: 提交阶段审核 (IN_PROGRESS → WAITING_APPROVAL)

```bash
curl -X POST "http://localhost:8080/api/sessions/6/phases/IDEA_GENERATION/submit-for-approval" \
  -H "Authorization: Bearer your-jwt-token" \
  -H "Content-Type: application/json" \
  -d '{
    "summary": "代理7提出了基于AI的智能推荐系统的创新想法，该方案具有广泛的应用前景和商业价值。"
  }'
```

### 步骤 4: 审核通过 (WAITING_APPROVAL → APPROVED → COMPLETED)

```bash
curl -X POST "http://localhost:8080/api/sessions/6/phases/IDEA_GENERATION/approve" \
  -H "Authorization: Bearer your-jwt-token"
```

### 步骤 5: 验证状态变更

```bash
curl -X GET "http://localhost:8080/api/sessions/6/status" \
  -H "Authorization: Bearer your-jwt-token"
```

## 可选的管理操作

### 暂停和恢复会话

```http
POST /api/sessions/{sessionId}/pause    # 暂停会话
POST /api/sessions/{sessionId}/resume   # 恢复会话
```

### 阶段审核拒绝和重试

```http
POST /api/sessions/{sessionId}/phases/{phaseType}/reject  # 拒绝阶段
POST /api/sessions/{sessionId}/phases/{phaseType}/retry   # 重新执行被拒绝的阶段
```

#### 拒绝流程示例

如果选择拒绝而不是通过：

**拒绝阶段 (WAITING_APPROVAL → REJECTED):**

```bash
curl -X POST "http://localhost:8080/api/sessions/6/phases/IDEA_GENERATION/reject" \
  -H "Authorization: Bearer your-jwt-token"
```

**重新执行 (REJECTED → IN_PROGRESS):**

```bash
curl -X POST "http://localhost:8080/api/sessions/6/phases/IDEA_GENERATION/retry" \
  -H "Authorization: Bearer your-jwt-token"
```

### 动态管理代理

```http
POST /api/sessions/{sessionId}/agents/{agentId}     # 添加代理
DELETE /api/sessions/{sessionId}/agents/{agentId}   # 移除代理
```

## 重要注意事项

1. **submit-for-approval 接口:** 已经实现，这个接口应该由 AI 代理完成阶段后自动调用，或者由系统内部调用。

2. **阶段执行:** 实际使用中，阶段的执行（从 IN_PROGRESS 到 WAITING_APPROVAL）应该是由 AI 代理自动完成的，不需要手动调用。

3. **用户操作:** 用户主要需要调用的接口是审核相关的接口：approve、reject、retry。

4. **状态监控:** 状态查询接口可以随时调用来监控进度。

5. **阶段顺序:** 每个阶段都会经历：NOT_STARTED → IN_PROGRESS → WAITING_APPROVAL → APPROVED → COMPLETED 的状态流转。

6. **三个阶段:** 系统包含三个阶段：
   - IDEA_GENERATION（创意生成）
   - FEASIBILITY_ANALYSIS（技术可行性分析）
   - DRAWBACK_DISCUSSION（缺点讨论）

## 测试数据准备

如果需要测试 submit-for-approval 接口，确保阶段有成功的代理响应数据：

```sql
-- 为阶段插入测试代理响应数据
INSERT INTO agent_responses (phase_id, agent_id, content, status, response_time_ms, created_at, updated_at) VALUES
(13, 7, '我建议开发一个基于AI的智能推荐系统...', 'SUCCESS', 1500, NOW(), NOW());
```

这样就完成了整个头脑风暴流程的完整指南！
